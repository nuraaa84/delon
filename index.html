<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–ª–æ—â–∞–¥—å –ø–æ –º–µ—Ç–æ–¥—É –ì–∞—É—Å—Å–∞</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 { color: #1a73e8; font-size: 24px; text-align: center;}
        
        .card {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        /* –ö–Ω–æ–ø–∫–∏ –∏ –∏–Ω–ø—É—Ç—ã */
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-primary { background-color: #1a73e8; color: white; }
        .btn-secondary { background-color: #e8f0fe; color: #1a73e8; }
        .btn-danger { background-color: #fce8e6; color: #c5221f; }
        .btn-active { ring: 3px solid #8ab4f8; font-weight: bold; transform: scale(0.98); }

        input[type="number"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 80px;
            font-size: 16px;
        }

        /* –ö–∞–Ω–≤–∞—Å */
        .canvas-wrapper {
            position: relative;
            overflow: auto;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: #fafafa;
            text-align: center;
        }
        canvas {
            max-width: 100%;
            display: block;
            margin: 0 auto;
            cursor: crosshair;
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã */
        .result-box {
            background: #e6fffa;
            border: 1px solid #b2f5ea;
            color: #2c7a7b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        .math-step {
            font-family: monospace;
            background: rgba(255,255,255,0.7);
            padding: 4px;
            margin: 4px 0;
            display: block;
            border-radius: 4px;
        }
        
        /* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è */
        .step-badge {
            background: #1a73e8; color: white;
            border-radius: 50%; width: 24px; height: 24px;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 14px; margin-right: 8px;
        }
    </style>
</head>
<body>

    <h1>üìê –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ì–∞—É—Å—Å–∞</h1>

    <div class="card">
        <label style="display:block; margin-bottom:10px; font-weight:bold;">1. –ó–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ</label>
        <input type="file" id="imageUpload" accept="image/*" style="width:100%">
    </div>

    <div class="card" id="toolsPanel" style="display:none;">
        <div class="btn-group">
            <button id="modeCalibrate" class="btn-secondary">üìè 2. –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</button>
            <button id="modeDraw" class="btn-secondary">‚úèÔ∏è 3. –û–±–≤–æ–¥–∫–∞</button>
        </div>
        
        <div id="calibrationControls" style="display:none; margin-top:10px; background:#f8f9fa; padding:10px; border-radius:8px;">
            <p style="margin:0 0 10px 0; font-size:14px;">–û—Ç–º–µ—Ç—å—Ç–µ 2 —Ç–æ—á–∫–∏ (–Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞).</p>
            <label>–î–ª–∏–Ω–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ (—Å–º): </label>
            <input type="number" id="realLengthInput" value="10">
            <button onclick="applyCalibration()" class="btn-primary" style="margin-top:5px; width:auto;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∞—Å—à—Ç–∞–±</button>
        </div>

        <div class="btn-group" style="margin-top:15px;">
            <button onclick="calculateArea()" class="btn-primary">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–ª–æ—â–∞–¥—å</button>
            <button onclick="clearCanvas()" class="btn-danger">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>

    <div class="canvas-wrapper">
        <canvas id="canvas"></canvas>
    </div>

    <div id="result" class="result-box"></div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let img = new Image();
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let mode = 'draw'; // 'calibrate' –∏–ª–∏ 'draw'
        let points = []; // –¢–æ—á–∫–∏ –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–∞
        let calibrationPoints = []; // 2 —Ç–æ—á–∫–∏ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∞
        let pixelsPerCm = 0; // –ú–∞—Å—à—Ç–∞–± (–ø–∏–∫—Å–µ–ª–µ–π –≤ 1 —Å–º)

        // –≠–ª–µ–º–µ–Ω—Ç—ã UI
        const toolsPanel = document.getElementById('toolsPanel');
        const calibPanel = document.getElementById('calibrationControls');
        const btnCalib = document.getElementById('modeCalibrate');
        const btnDraw = document.getElementById('modeDraw');

        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
        document.getElementById('imageUpload').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    toolsPanel.style.display = 'block';
                    resetAll();
                    setMode('calibrate'); // –°—Ä–∞–∑—É –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∫–∞–ª–∏–±—Ä–æ–≤–∫—É
                }
                img.src = event.target.result;
            }
            if(e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
        });

        // 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞–º–∏
        btnCalib.addEventListener('click', () => setMode('calibrate'));
        btnDraw.addEventListener('click', () => setMode('draw'));

        function setMode(newMode) {
            mode = newMode;
            if (mode === 'calibrate') {
                btnCalib.className = 'btn-primary';
                btnDraw.className = 'btn-secondary';
                calibPanel.style.display = 'block';
            } else {
                btnCalib.className = 'btn-secondary';
                btnDraw.className = 'btn-primary';
                calibPanel.style.display = 'none';
            }
            draw();
        }

        // 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤
        canvas.addEventListener('click', (e) => {
            if (!img.src) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (mode === 'calibrate') {
                if (calibrationPoints.length >= 2) calibrationPoints = []; // –°–±—Ä–æ—Å, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ª–∏–Ω–∏—è
                calibrationPoints.push({x, y});
            } else {
                points.push({x, y});
            }
            draw();
        });

        // 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∞
        window.applyCalibration = function() {
            if (calibrationPoints.length < 2) {
                alert("–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç–∞–≤—å—Ç–µ 2 —Ç–æ—á–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ!");
                return;
            }
            const p1 = calibrationPoints[0];
            const p2 = calibrationPoints[1];
            // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –ø–æ —Ç–µ–æ—Ä–µ–º–µ –ü–∏—Ñ–∞–≥–æ—Ä–∞
            const distPx = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
            const realCm = parseFloat(document.getElementById('realLengthInput').value);
            
            if (!realCm || realCm <= 0) {
                alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–ª–∏–Ω—É –≤ —Å–º");
                return;
            }

            pixelsPerCm = distPx / realCm;
            alert(`–ú–∞—Å—à—Ç–∞–± —Å–æ—Ö—Ä–∞–Ω–µ–Ω! ${pixelsPerCm.toFixed(2)} –ø–∏–∫—Å = 1 —Å–º.\n–¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –≤ —Ä–µ–∂–∏–º "–û–±–≤–æ–¥–∫–∞" –∏ –æ—Ç–º–µ—Ç—å—Ç–µ —Ñ–∏–≥—É—Ä—É.`);
            setMode('draw');
        };

        // 5. –†–∞—Å—á–µ—Ç –ø–ª–æ—â–∞–¥–∏ (–ú–µ—Ç–æ–¥ –ì–∞—É—Å—Å–∞)
        window.calculateArea = function() {
            if (points.length < 3) {
                alert("–î–ª—è —Ñ–∏–≥—É—Ä—ã –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏!");
                return;
            }

            // –§–æ—Ä–º—É–ª–∞ —à–Ω—É—Ä–∫–æ–≤ (Shoelace formula)
            let sum1 = 0;
            let sum2 = 0;
            const n = points.length;

            for (let i = 0; i < n; i++) {
                let p1 = points[i];
                let p2 = points[(i + 1) % n]; // –°–ª–µ–¥—É—é—â–∞—è —Ç–æ—á–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω—è—è —Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è —Å –ø–µ—Ä–≤–æ–π)
                
                sum1 += p1.x * p2.y;
                sum2 += p1.y * p2.x;
            }

            const areaPx = Math.abs(sum1 - sum2) / 2;
            
            // –í—ã–≤–æ–¥
            const resDiv = document.getElementById('result');
            resDiv.style.display = 'block';
            let html = `<h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç</h3>`;
            html += `<span class="math-step">–ü–ª–æ—â–∞–¥—å –≤ –ø–∏–∫—Å–µ–ª—è—Ö: ${Math.round(areaPx)} px¬≤</span>`;

            if (pixelsPerCm > 0) {
                // –ü–µ—Ä–µ–≤–æ–¥ –≤ —Å–º¬≤: –¥–µ–ª–∏–º –ø–∏–∫—Å–µ–ª—å–Ω—É—é –ø–ª–æ—â–∞–¥—å –Ω–∞ –∫–≤–∞–¥—Ä–∞—Ç –º–∞—Å—à—Ç–∞–±–∞
                const areaCm = areaPx / (pixelsPerCm * pixelsPerCm);
                html += `<span class="math-step" style="background:#c6f6d5; font-weight:bold; color:#22543d">–ü–ª–æ—â–∞–¥—å —Ä–µ–∞–ª—å–Ω–∞—è: ${areaCm.toFixed(2)} —Å–º¬≤</span>`;
            } else {
                html += `<p style="color:#c53030">‚ö†Ô∏è –ú–∞—Å—à—Ç–∞–± –Ω–µ –∑–∞–¥–∞–Ω! –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫—É (—à–∞–≥ 2), —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö.</p>`;
            }
            
            resDiv.innerHTML = html;
            resDiv.scrollIntoView({ behavior: 'smooth' });
        };

        window.clearCanvas = function() {
            points = [];
            calibrationPoints = [];
            pixelsPerCm = 0;
            document.getElementById('result').style.display = 'none';
            draw();
        };

        function resetAll() {
            points = [];
            calibrationPoints = [];
            pixelsPerCm = 0;
            document.getElementById('result').style.display = 'none';
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);

            // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ (—Å–∏–Ω—è—è)
            if (calibrationPoints.length > 0) {
                ctx.strokeStyle = '#3182ce';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(calibrationPoints[0].x, calibrationPoints[0].y);
                calibrationPoints.forEach(p => ctx.lineTo(p.x, p.y));
                ctx.stroke();

                calibrationPoints.forEach(p => {
                    ctx.fillStyle = '#3182ce';
                    ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2); ctx.fill();
                });
            }

            // –†–∏—Å—É–µ–º –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫ (–∫—Ä–∞—Å–Ω—ã–π)
            if (points.length > 0) {
                ctx.strokeStyle = '#e53e3e';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                points.forEach(p => ctx.lineTo(p.x, p.y));
                if (points.length > 2) ctx.lineTo(points[0].x, points[0].y); // –ó–∞–º—ã–∫–∞–µ–º
                ctx.stroke();
                
                // –ó–∞–ª–∏–≤–∫–∞
                ctx.fillStyle = 'rgba(229, 62, 62, 0.2)';
                ctx.fill();

                points.forEach((p, i) => {
                    ctx.fillStyle = '#e53e3e';
                    ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();
                    // –ù–æ–º–µ—Ä–∞ —Ç–æ—á–µ–∫
                    ctx.fillStyle = 'white';
                    ctx.font = '14px monospace';
                    ctx.strokeText(i+1, p.x+8, p.y-8);
                    ctx.fillText(i+1, p.x+8, p.y-8);
                });
            }
        }
    </script>
</body>
</html>
